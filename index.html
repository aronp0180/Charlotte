<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Taakmanager â€” Directeur</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #0F172A; color: #E2E8F0; font-family: 'Segoe UI', sans-serif; min-height: 100vh; }
    .header { background: linear-gradient(135deg, #0F172A 0%, #1E3A5F 50%, #0F172A 100%); padding: 28px 20px 22px; border-bottom: 1px solid #1E3A5F; position: relative; overflow: hidden; }
    .header::before { content:''; position:absolute; top:-60px; right:-60px; width:220px; height:220px; background:radial-gradient(circle,#2563EB22,transparent 70%); border-radius:50%; }
    .header-date { font-size:12px; color:#60A5FA; font-weight:600; letter-spacing:1.5px; text-transform:uppercase; margin-bottom:4px; }
    .header-title { font-size:26px; font-weight:900; color:#F1F5F9; margin-bottom:4px; }
    .header-sub { font-size:14px; color:#94A3B8; }
    .nav { display:grid; grid-template-columns:repeat(3,1fr); gap:6px; margin-top:18px; }
    .nav-btn { padding:10px 4px; border-radius:10px; border:1px solid #334155; background:#1E293B; color:#94A3B8; font-weight:700; font-size:12px; cursor:pointer; text-align:center; width:100%; }
    .nav-btn.active { background:linear-gradient(135deg,#2563EB,#1D4ED8); color:#fff; border:none; box-shadow:0 2px 12px rgba(37,99,235,.5); }
    .melding { padding:9px 20px; text-align:center; font-weight:600; font-size:14px; display:none; }
    .melding.success { background:#14532D; color:#86EFAC; }
    .melding.error { background:#7F1D1D; color:#FCA5A5; }
    .container { max-width:780px; margin:0 auto; padding:20px 14px; }
    .tab { display:none; } .tab.active { display:block; }
    .card { background:#1E293B; border-radius:16px; padding:20px; box-shadow:0 4px 24px rgba(0,0,0,.4); border:1px solid #334155; margin-bottom:10px; }
    .btn-primary { background:linear-gradient(135deg,#2563EB,#1D4ED8); color:#fff; border:none; border-radius:10px; padding:9px 18px; cursor:pointer; font-weight:700; font-size:14px; box-shadow:0 2px 12px rgba(37,99,235,.4); }
    .btn-outline { background:transparent; color:#60A5FA; border:1.5px solid #2563EB; border-radius:10px; padding:8px 14px; cursor:pointer; font-weight:600; font-size:13px; }
    .btn-green { background:transparent; color:#34D399; border:1.5px solid #059669; border-radius:10px; padding:8px 14px; cursor:pointer; font-weight:600; font-size:13px; }
    .btn-danger { background:none; border:none; cursor:pointer; color:#EF4444; font-size:16px; opacity:.7; }
    .btn-mic { background:linear-gradient(135deg,#7C3AED,#5B21B6); color:#fff; border:none; border-radius:12px; padding:11px 16px; cursor:pointer; font-size:20px; box-shadow:0 2px 12px rgba(124,58,237,.4); transition:all .2s; flex-shrink:0; }
    .btn-mic.luisteren { background:linear-gradient(135deg,#DC2626,#B91C1C); box-shadow:0 2px 20px rgba(220,38,38,.6); animation:pulse 1s infinite; }
    @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.08)} }
    input, select { width:100%; padding:10px 14px; border-radius:10px; border:1.5px solid #334155; background:#0F172A; color:#E2E8F0; font-size:14px; outline:none; margin-bottom:10px; }
    select option { background:#1E293B; }
    .action-bar { display:flex; gap:8px; margin-bottom:16px; flex-wrap:wrap; }
    .filters { display:flex; gap:6px; margin-bottom:14px; flex-wrap:wrap; }
    .filter-btn { padding:5px 13px; border-radius:99px; border:none; cursor:pointer; font-weight:700; font-size:12px; background:#1E293B; color:#64748B; }
    .filter-btn.active { color:#fff; }
    .taak { display:flex; gap:12px; align-items:flex-start; }
    .taak input[type=checkbox] { margin-top:3px; width:18px; height:18px; cursor:pointer; accent-color:#2563EB; flex-shrink:0; }
    .taak-info { flex:1; }
    .taak-titel { font-weight:700; font-size:15px; color:#F1F5F9; }
    .taak-titel.voltooid { text-decoration:line-through; opacity:.6; }
    .taak-omsch { font-size:13px; color:#64748B; margin-top:3px; }
    .taak-datum { font-size:12px; color:#475569; margin-top:3px; }
    .badge { border-radius:99px; padding:2px 10px; font-size:12px; font-weight:700; margin-left:6px; }
    .stats { display:flex; gap:10px; margin-top:20px; flex-wrap:wrap; }
    .stat { flex:1; min-width:80px; background:#0F172A; border-radius:12px; padding:14px 12px; text-align:center; border:1px solid #1E293B; }
    .stat-val { font-size:26px; font-weight:900; }
    .stat-lbl { font-size:11px; color:#64748B; margin-top:2px; }
    .sectie-titel { font-size:13px; font-weight:800; letter-spacing:1px; text-transform:uppercase; margin:10px 0 8px; }
    .chat-box { display:flex; flex-direction:column; height:calc(100vh - 300px); min-height:300px; }
    .chat-msgs { flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:12px; padding-bottom:12px; }
    .chat-bubble-wrap { display:flex; align-items:flex-end; gap:8px; }
    .chat-bubble-wrap.user { justify-content:flex-end; }
    .chat-avatar { width:32px; height:32px; border-radius:50%; background:linear-gradient(135deg,#2563EB,#1D4ED8); display:flex; align-items:center; justify-content:center; font-size:16px; flex-shrink:0; }
    .chat-bubble { max-width:78%; padding:11px 15px; font-size:14px; line-height:1.6; white-space:pre-wrap; box-shadow:0 2px 8px rgba(0,0,0,.3); }
    .chat-bubble.assistant { background:#1E293B; border:1px solid #334155; border-radius:18px 18px 18px 4px; color:#E2E8F0; }
    .chat-bubble.user { background:linear-gradient(135deg,#2563EB,#1D4ED8); border-radius:18px 18px 4px 18px; color:#fff; }
    .chat-input-bar { display:flex; gap:8px; padding-top:10px; border-top:1px solid #1E293B; align-items:center; }
    .chat-input-bar input { margin:0; border-radius:12px; flex:1; }
    .chat-send { background:linear-gradient(135deg,#2563EB,#1D4ED8); color:#fff; border:none; border-radius:12px; padding:11px 18px; cursor:pointer; font-size:18px; font-weight:700; flex-shrink:0; }
    .spraak-status { font-size:12px; color:#7C3AED; font-weight:600; text-align:center; padding:6px; display:none; }
    .spraak-status.zichtbaar { display:block; }
    .inst-section { background:#0F172A; border-radius:12px; padding:16px; margin-bottom:20px; border:1px solid #1E3A5F; }
    .inst-title { color:#60A5FA; font-size:14px; margin:0 0 12px; text-transform:uppercase; letter-spacing:1px; font-weight:700; }
    .inst-label { font-size:13px; color:#94A3B8; font-weight:600; display:block; margin-bottom:6px; }
    .step { display:flex; gap:10px; margin-bottom:6px; align-items:flex-start; font-size:13px; color:#94A3B8; }
    .step-nr { background:#2563EB; color:#fff; border-radius:50%; width:22px; height:22px; display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:800; flex-shrink:0; }
    a { color:#60A5FA; }
    .empty { text-align:center; color:#475569; padding:48px 0; }
    .warn-box { background:#1E293B; border:1px solid #2563EB44; border-radius:12px; padding:14px; margin-bottom:16px; font-size:13px; color:#93C5FD; }
    .form-row { display:flex; gap:10px; }
    .form-row > div { flex:1; }
    .form-row input { margin-bottom:0; }
    label.small { font-size:11px; color:#64748B; font-weight:600; display:block; margin-bottom:4px; }
  </style>
</head>
<body>

<div class="header">
  <div class="header-date" id="headerDatum"></div>
  <h1 class="header-title">Welkom, Directeur ğŸ˜</h1>
  <p class="header-sub">Hoe kan ik u helpen vandaag?</p>
  <div class="nav">
    <button class="nav-btn active" onclick="setTab('taken')">âœ… Taken</button>
    <button class="nav-btn" onclick="setTab('agenda')">ğŸ“… Agenda</button>
    <button class="nav-btn" onclick="setTab('chat')">ğŸ’¬ Chat</button>

  </div>
</div>

<div class="melding" id="melding"></div>

<div class="container">

  <!-- TAKEN -->
  <div class="tab active" id="tab-taken">
    <div class="action-bar">
      <button class="btn-primary" onclick="toggleFormulier()">+ Nieuwe taak</button>
      <button class="btn-outline" onclick="laadAlles()">ğŸ”„ Vernieuwen</button>
      <button class="btn-green" onclick="stuurDagmail()">âœ‰ï¸ Dagrapport</button>
    </div>
    <div class="card" id="nieuw-formulier" style="display:none">
      <h3 style="color:#F1F5F9;margin-bottom:14px">+ Nieuwe taak</h3>
      <input id="nieuw-titel" placeholder="Taaknaam *" />
      <input id="nieuw-omsch" placeholder="Omschrijving (optioneel)" />
      <div class="form-row">
        <div><select id="nieuw-cat"><option>Werk</option><option>Persoonlijk</option><option>Gezondheid</option><option>Yenz</option></select></div>
        <div><input id="nieuw-datum" type="date" style="color-scheme:dark" /></div>
      </div>
      <button class="btn-primary" onclick="voegTaakToe()">Taak toevoegen</button>
    </div>
    <div class="filters" id="filters"></div>
    <div id="taken-lijst"></div>
    <div class="stats" id="stats"></div>
  </div>

  <!-- AGENDA -->
  <div class="tab" id="tab-agenda">
    <div class="action-bar">
      <button class="btn-primary" onclick="toggleAfspraakFormulier()">+ Nieuwe afspraak</button>
      <button class="btn-outline" onclick="laadAlles()">ğŸ”„ Vernieuwen</button>
    </div>
    <div class="card" id="afspraak-formulier" style="display:none">
      <h3 style="color:#F1F5F9;margin-bottom:14px">Nieuwe afspraak</h3>
      <input id="afspr-titel" placeholder="Titel *" />
      <div class="form-row">
        <div><label class="small">Datum</label><input id="afspr-datum" type="date" style="color-scheme:dark" /></div>
        <div><label class="small">Start</label><input id="afspr-start" type="time" /></div>
        <div><label class="small">Einde</label><input id="afspr-eind" type="time" /></div>
      </div>
      <input id="afspr-locatie" placeholder="ğŸ“ Locatie" />
      <button class="btn-primary" onclick="maakAfspraak()">ğŸ“… Afspraak aanmaken</button>
    </div>
    <div id="afspraken-lijst"></div>
  </div>

  <!-- CHAT -->
  <div class="tab" id="tab-chat">
    <div class="chat-box">
      <div class="chat-msgs" id="chat-msgs"></div>
      <div class="spraak-status" id="spraak-status">ğŸ¤ Luisteren...</div>
      <div class="chat-input-bar">
        <input id="chat-input" placeholder="Typ of spreek uw opdracht, directeur..." onkeydown="if(event.key==='Enter')stuurChat()" />
        <button class="btn-mic" id="mic-btn" onclick="toggleSpreken()" title="Spraakherkenning">ğŸ¤</button>
        <button class="chat-send" onclick="stuurChat()">â¤</button>
      </div>
    </div>
  </div>



</div>

<script>
// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx1LJyOVA7x4QuEQr8podM_kSeJPdR0CEhBQbvbN20Kl7Q0Pwn9UXvHU2GigI2TTK0G/exec";
const CAT_KLEUREN = { Werk:"#3B82F6", Persoonlijk:"#8B5CF6", Gezondheid:"#10B981", Yenz:"#F43F5E" };

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let taken = [], afspraken = [], afsprakenIcs = [], huidigFilter = "Alles", chatHistory = [];
let herkenning = null, luistert = false;

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.onload = () => {
  document.getElementById("headerDatum").textContent =
    new Date().toLocaleDateString("nl-NL", { weekday:"long", day:"numeric", month:"long", year:"numeric" });
  setupSpreak();
  renderFilters();
  voegChatBericht("assistant", "Goedendag, directeur! ğŸ‘‹\n\nIk kan voor u taken beheren en afspraken aanmaken. Probeer:\nâ€¢ \"Plan een vergadering morgen om 14:00\"\nâ€¢ \"Voeg taak toe: offerte maken, Werk, voor vrijdag\"\n\nOf druk op ğŸ¤ om te spreken!");
  laadAlles();
  setInterval(laadAlles, 60000);
};

// â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setTab(naam) {
  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
  document.getElementById("tab-" + naam).classList.add("active");
  document.querySelectorAll(".nav-btn")[["taken","agenda","chat","instellingen"].indexOf(naam)]?.classList.add("active");
}

// â”€â”€ MELDING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toonMelding(tekst, type="success") {
  const el = document.getElementById("melding");
  el.textContent = (type==="error" ? "âš ï¸ " : "âœ“ ") + tekst;
  el.className = "melding " + type;
  el.style.display = "block";
  setTimeout(() => el.style.display = "none", 4000);
}

// â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function appsScript(body) {
  try {
    const res = await fetch(SCRIPT_URL, { method:"POST", body: JSON.stringify(body) });
    const data = await res.json();
    if (!data.succes) throw new Error(data.fout || "Onbekende fout");
    return data.data;
  } catch(e) { toonMelding("Fout: " + e.message, "error"); return null; }
}

async function testVerbinding() {
  try {
    const res = await fetch(SCRIPT_URL + "?t=" + Date.now());
    const json = await res.json();
    toonMelding(json.succes ? `âœ… Verbinding werkt! Afspraken: ${json.data?.afspraken?.length||0}, Taken: ${json.data?.taken?.length||0}` : "Fout: " + json.fout, json.succes ? "success" : "error");
  } catch(e) { toonMelding("âŒ Mislukt: " + e.message, "error"); }
}

// â”€â”€ LADEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function laadAlles() {
  // Google taken + afspraken
  try {
    const res = await fetch(SCRIPT_URL + "?t=" + Date.now());
    const data = await res.json();
    if (data.succes) {
      taken = data.data?.taken || [];
      afspraken = data.data?.afspraken || [];
    }
  } catch(e) { toonMelding("Google laden mislukt: " + e.message, "error"); }

  // ICS agenda
  try {
    const res = await fetch(SCRIPT_URL + "?actie=ics&t=" + Date.now());
    const buf = await res.arrayBuffer();
    const tekst = new TextDecoder("utf-8").decode(buf);
    if (tekst.includes("BEGIN:VCALENDAR")) afsprakenIcs = parseIcs(tekst);
  } catch(e) { toonMelding("ICS laden mislukt: " + e.message, "error"); }

  renderTaken();
  renderStats();
  renderAfspraken();
}

// â”€â”€ TAKEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleFormulier() {
  const f = document.getElementById("nieuw-formulier");
  f.style.display = f.style.display === "none" ? "block" : "none";
}

async function voegTaakToe(taakData) {
  const titel = taakData?.titel || document.getElementById("nieuw-titel").value.trim();
  if (!titel) { toonMelding("Vul een taaknaam in.", "error"); return null; }
  const taak = taakData || { titel, omschrijving: document.getElementById("nieuw-omsch").value, categorie: document.getElementById("nieuw-cat").value, vervaldatum: document.getElementById("nieuw-datum").value };
  const result = await appsScript({ actie:"voeg_taak_toe", taak });
  if (result) {
    taken.unshift(result); renderTaken(); renderStats();
    if (!taakData) {
      ["nieuw-titel","nieuw-omsch","nieuw-datum"].forEach(id => document.getElementById(id).value = "");
      document.getElementById("nieuw-formulier").style.display = "none";
    }
    toonMelding("Taak toegevoegd! âœ…");
  }
  return result;
}

async function toggleVoltooid(id) {
  const t = taken.find(x => x.id === id);
  if (!t) return;
  t.voltooid = !t.voltooid;
  await appsScript({ actie:"update_taak", taak: t });
  renderTaken(); renderStats();
}

async function verwijderTaak(id) {
  await appsScript({ actie:"verwijder_taak", id });
  taken = taken.filter(t => t.id !== id);
  renderTaken(); renderStats();
}

async function stuurDagmail() {
  const r = await appsScript({ actie:"stuur_dagmail" });
  if (r) toonMelding(r.verstuurd ? "Dagrapport verstuurd! âœ‰ï¸" : "Geen openstaande taken.", r.verstuurd ? "success" : "error");
}

function taakKaart(t) {
  const kl = CAT_KLEUREN[t.categorie] || "#6B7280";
  return `<div class="card taak" style="opacity:${t.voltooid?.5:1}">
    <input type="checkbox" ${t.voltooid?"checked":""} onchange="toggleVoltooid('${t.id}')" />
    <div class="taak-info">
      <div style="display:flex;align-items:center;flex-wrap:wrap;gap:6px">
        <span class="taak-titel ${t.voltooid?'voltooid':''}">${t.titel}</span>
        <span class="badge" style="background:${kl}22;color:${kl};border:1px solid ${kl}44">${t.categorie||""}</span>
      </div>
      ${t.omschrijving?`<div class="taak-omsch">${t.omschrijving}</div>`:""}
      ${t.vervaldatum?`<div class="taak-datum">ğŸ“… ${new Date(t.vervaldatum+"T12:00:00").toLocaleDateString("nl-NL")}</div>`:""}
    </div>
    <button class="btn-danger" onclick="verwijderTaak('${t.id}')">ğŸ—‘</button>
  </div>`;
}

function renderFilters() {
  const cats = ["Alles","Werk","Persoonlijk","Gezondheid","Yenz","Voltooid"];
  document.getElementById("filters").innerHTML = cats.map(f => {
    const kl = CAT_KLEUREN[f] || "#2563EB";
    return `<button class="filter-btn ${f===huidigFilter?'active':''}" onclick="setFilter('${f}')"
      style="${f===huidigFilter?`background:${kl};box-shadow:0 2px 8px ${kl}55`:''}">${f}</button>`;
  }).join("");
}

function setFilter(f) { huidigFilter = f; renderFilters(); renderTaken(); }

function renderTaken() {
  const el = document.getElementById("taken-lijst");
  const vandaag = new Date().toISOString().split("T")[0];
  const nu = new Date();

  let basis = huidigFilter==="Voltooid" ? taken.filter(t=>t.voltooid)
    : huidigFilter==="Alles" ? taken.filter(t=>!t.voltooid)
    : taken.filter(t=>t.categorie===huidigFilter&&!t.voltooid);

  if (huidigFilter==="Voltooid") { el.innerHTML = basis.length ? basis.map(taakKaart).join("") : '<div class="empty">Geen voltooide taken.</div>'; return; }

  const dag = nu.getDay()===0?6:nu.getDay()-1;
  const ma = new Date(nu); ma.setDate(nu.getDate()-dag); ma.setHours(0,0,0,0);
  const zo = new Date(ma); zo.setDate(ma.getDate()+6); zo.setHours(23,59,59,999);

  const doorgeschoven = basis.filter(t => t.vervaldatum && t.vervaldatum < vandaag);
  const vandaagT      = basis.filter(t => t.vervaldatum === vandaag);
  const dezeWeek      = basis.filter(t => { if (!t.vervaldatum||t.vervaldatum<=vandaag) return false; const d=new Date(t.vervaldatum+"T12:00:00"); return d>=ma&&d<=zo; });
  const later         = basis.filter(t => t.vervaldatum && new Date(t.vervaldatum+"T12:00:00") > zo);
  const geenDatum     = basis.filter(t => !t.vervaldatum);

  let html = "";
  if (doorgeschoven.length) { html += `<div class="sectie-titel" style="color:#EF4444">âš ï¸ Doorgeschoven</div>${doorgeschoven.map(taakKaart).join("")}`; }
  html += `<div class="sectie-titel" style="color:#60A5FA">ğŸ“Œ Vandaag</div>`;
  html += vandaagT.length ? vandaagT.map(taakKaart).join("") : `<div style="color:#475569;font-size:13px;padding:8px 0 12px">Geen taken voor vandaag.</div>`;
  html += `<div class="sectie-titel" style="color:#60A5FA">ğŸ“… Deze week</div>`;
  html += dezeWeek.length ? dezeWeek.map(taakKaart).join("") : `<div style="color:#475569;font-size:13px;padding:8px 0 12px">Geen verdere taken deze week.</div>`;
  if (later.length)    html += `<div class="sectie-titel" style="color:#60A5FA">ğŸ—“ï¸ Later</div>${later.map(taakKaart).join("")}`;
  if (geenDatum.length) html += `<div class="sectie-titel" style="color:#64748B">ğŸ“‹ Geen datum</div>${geenDatum.map(taakKaart).join("")}`;
  el.innerHTML = html || '<div class="empty">Geen taken gevonden.</div>';
}

function renderStats() {
  document.getElementById("stats").innerHTML = [
    {l:"Totaal",v:taken.length,c:"#3B82F6"},
    {l:"Openstaand",v:taken.filter(t=>!t.voltooid).length,c:"#3B82F6"},
    {l:"Voltooid",v:taken.filter(t=>t.voltooid).length,c:"#34D399"},
    {l:"Werktaken",v:taken.filter(t=>t.categorie==="Werk"&&!t.voltooid).length,c:"#F59E0B"},
  ].map(s=>`<div class="stat"><div class="stat-val" style="color:${s.c}">${s.v}</div><div class="stat-lbl">${s.l}</div></div>`).join("");
}

// â”€â”€ AGENDA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleAfspraakFormulier() {
  const f = document.getElementById("afspraak-formulier");
  f.style.display = f.style.display==="none" ? "block" : "none";
}

async function maakAfspraak(afsprData) {
  const titel = afsprData?.titel || document.getElementById("afspr-titel").value.trim();
  const datum  = afsprData?.datum || document.getElementById("afspr-datum").value;
  const start  = afsprData?.startTijd || document.getElementById("afspr-start").value;
  if (!titel||!datum||!start) { toonMelding("Vul titel, datum en starttijd in.", "error"); return null; }
  const afspraak = afsprData || { titel, datum, startTijd:start, eindTijd:document.getElementById("afspr-eind").value||start, locatie:document.getElementById("afspr-locatie").value, deelnemers:"" };
  const result = await appsScript({ actie:"maak_afspraak", afspraak });
  if (result) {
    afspraken.unshift(result); renderAfspraken();
    if (!afsprData) document.getElementById("afspraak-formulier").style.display = "none";
    toonMelding("Afspraak aangemaakt! ğŸ“…");
  }
  return result;
}

async function verwijderAfspraak(id) {
  await appsScript({ actie:"verwijder_afspraak", id });
  afspraken = afspraken.filter(a => a.id !== id);
  renderAfspraken();
  toonMelding("Afspraak verwijderd.");
}

function afspraakKaart(a) {
  const isOutlook = a.bron === "outlook";
  return `<div class="card">
    <div style="display:flex;justify-content:space-between;align-items:flex-start">
      <div style="font-weight:700;font-size:15px;color:#F1F5F9">${isOutlook?"ğŸ“§":"ğŸ“…"} ${a.titel}</div>
      ${!isOutlook?`<button class="btn-danger" onclick="verwijderAfspraak('${a.id}')">ğŸ—‘</button>`:""}
    </div>
    <div style="font-size:13px;color:#60A5FA;margin-top:4px;font-weight:600">
      ${a.datum?new Date(a.datum+"T12:00:00").toLocaleDateString("nl-NL",{weekday:"long",day:"numeric",month:"long"}):""}
      ${a.startTijd?" Â· "+a.startTijd+(a.eindTijd&&a.eindTijd!==a.startTijd?" â€“ "+a.eindTijd:""):""}
    </div>
    ${a.locatie?`<div style="font-size:13px;color:#64748B;margin-top:3px">ğŸ“ ${a.locatie}</div>`:""}
    <div style="display:flex;align-items:center;justify-content:space-between;margin-top:6px">
      <div style="font-size:11px;font-weight:600;color:${isOutlook?"#60A5FA":"#34D399"}">${isOutlook?"ğŸ“§ Outlook Krimpenerwaard":"âœ“ Google Agenda"}</div>
      ${a.datum&&!isOutlook?`<a href="https://calendar.google.com/calendar/r/day/${a.datum.replace(/-/g,'/')}?q=${encodeURIComponent(a.titel)}" target="_blank"
        style="font-size:12px;color:#60A5FA;font-weight:600;text-decoration:none;background:#0F172A;padding:4px 10px;border-radius:8px;border:1px solid #2563EB44">ğŸ“… Open dag â†’</a>`:""}
    </div>
  </div>`;
}

function renderAfspraken() {
  const el = document.getElementById("afspraken-lijst");
  const vandaag = new Date().toISOString().split("T")[0];
  const nu = new Date();
  const dag = nu.getDay()===0?6:nu.getDay()-1;
  const ma = new Date(nu); ma.setDate(nu.getDate()-dag); ma.setHours(0,0,0,0);
  const zo = new Date(ma); zo.setDate(ma.getDate()+6); zo.setHours(23,59,59,999);

  const alle = [...afspraken, ...afsprakenIcs]
    .filter(a => a.datum >= vandaag)
    .sort((a,b) => (a.datum+a.startTijd).localeCompare(b.datum+b.startTijd));

  if (!alle.length) { el.innerHTML='<div class="empty"><div style="font-size:40px;margin-bottom:10px">ğŸ“…</div>Geen afspraken gevonden.</div>'; return; }

  const vandaagA  = alle.filter(a => a.datum === vandaag);
  const dezeWeekA = alle.filter(a => { const d=new Date(a.datum+"T12:00:00"); return a.datum!==vandaag&&d>=ma&&d<=zo; });
  const laterA    = alle.filter(a => new Date(a.datum+"T12:00:00") > zo);

  let html = `<div class="sectie-titel" style="color:#60A5FA">ğŸ“Œ Vandaag</div>`;
  html += vandaagA.length ? vandaagA.map(afspraakKaart).join("") : `<div style="color:#475569;font-size:13px;padding:8px 0 12px">Geen afspraken vandaag.</div>`;
  html += `<div class="sectie-titel" style="color:#60A5FA">ğŸ“… Deze week</div>`;
  html += dezeWeekA.length ? dezeWeekA.map(afspraakKaart).join("") : `<div style="color:#475569;font-size:13px;padding:8px 0 12px">Geen verdere afspraken deze week.</div>`;
  if (laterA.length) html += `<div class="sectie-titel" style="color:#60A5FA">ğŸ—“ï¸ Later</div>${laterA.map(afspraakKaart).join("")}`;
  el.innerHTML = html;
}

// â”€â”€ ICS PARSER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseIcs(tekst) {
  tekst = tekst.replace(/\r\n/g,"\n").replace(/\r/g,"\n").replace(/\n[ \t]/g,"");
  const events = [];
  let inEvent = false, huidig = {};
  for (const raw of tekst.split("\n")) {
    const r = raw.trim();
    if (!r) continue;
    if (r==="BEGIN:VEVENT") { inEvent=true; huidig={}; continue; }
    if (r==="END:VEVENT")   { inEvent=false; if (huidig.DTSTART) events.push({...huidig}); continue; }
    if (!inEvent) continue;
    const idx = r.indexOf(":");
    if (idx===-1) continue;
    huidig[r.substring(0,idx).split(";")[0].toUpperCase().trim()] = r.substring(idx+1).trim();
  }
  const pad = n => String(n).padStart(2,"0");
  const parseDt = s => {
    if (!s) return null;
    const m = s.replace(/Z$/i,"").match(/(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})/);
    if (m) return new Date(`${m[1]}-${m[2]}-${m[3]}T${m[4]}:${m[5]}:${m[6]}`);
    const d = s.match(/(\d{4})(\d{2})(\d{2})/);
    if (d) return new Date(`${d[1]}-${d[2]}-${d[3]}T00:00:00`);
    return null;
  };
  const gezien = new Set();
  return events
    .filter(ev => { if (!ev.UID||!gezien.has(ev.UID)){if(ev.UID)gezien.add(ev.UID);return true;}return false; })
    .map(ev => {
      const s=parseDt(ev.DTSTART), e=parseDt(ev.DTEND);
      if (!s) return null;
      return { id:"ics_"+(ev.UID||Math.random().toString(36).substr(2,8)).replace(/\s/g,"").substring(0,20), titel:ev.SUMMARY||"(geen titel)", datum:`${s.getFullYear()}-${pad(s.getMonth()+1)}-${pad(s.getDate())}`, startTijd:`${pad(s.getHours())}:${pad(s.getMinutes())}`, eindTijd:e?`${pad(e.getHours())}:${pad(e.getMinutes())}` :"", locatie:ev.LOCATION||"", bron:"outlook" };
    }).filter(Boolean);
}

// â”€â”€ SPRAAK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupSpreak() {
  const SR = window.SpeechRecognition||window.webkitSpeechRecognition;
  if (!SR) { document.getElementById("mic-btn").style.display="none"; return; }
  herkenning = new SR();
  herkenning.lang="nl-NL"; herkenning.continuous=false; herkenning.interimResults=true;
  herkenning.onresult = e => {
    document.getElementById("chat-input").value = Array.from(e.results).map(r=>r[0].transcript).join("");
    if (e.results[e.results.length-1].isFinal) { stopSpreken(); setTimeout(stuurChat,300); }
  };
  herkenning.onend = stopSpreken;
  herkenning.onerror = stopSpreken;
}
function toggleSpreken() { luistert?stopSpreken():startSpreken(); }
function startSpreken() {
  if (!herkenning) return;
  luistert=true;
  document.getElementById("mic-btn").classList.add("luisteren");
  document.getElementById("mic-btn").textContent="ğŸ”´";
  document.getElementById("spraak-status").classList.add("zichtbaar");
  herkenning.start();
}
function stopSpreken() {
  luistert=false;
  document.getElementById("mic-btn").classList.remove("luisteren");
  document.getElementById("mic-btn").textContent="ğŸ¤";
  document.getElementById("spraak-status").classList.remove("zichtbaar");
  try { herkenning.stop(); } catch {}
}
function spreekUit(tekst) {
  if (!window.speechSynthesis) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(tekst.replace(/[âœ…ğŸ—‘ï¸ğŸ“…âš ï¸ğŸ’¬ğŸ‘‹ğŸ¤]/g,"").substring(0,200));
  u.lang="nl-NL"; u.rate=1.05;
  window.speechSynthesis.speak(u);
}

// â”€â”€ CHAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function voegChatBericht(rol, inhoud) {
  chatHistory.push({ role:rol, content:inhoud });
  document.getElementById("chat-msgs").innerHTML = chatHistory.map(m=>`
    <div class="chat-bubble-wrap ${m.role}">
      ${m.role==="assistant"?'<div class="chat-avatar">ğŸ¤–</div>':""}
      <div class="chat-bubble ${m.role}">${m.content}</div>
    </div>`).join("");
  document.getElementById("chat-msgs").scrollTop = 99999;
}

async function stuurChat() {
  const input = document.getElementById("chat-input");
  const tekst = input.value.trim();
  if (!tekst) return;
  input.value = "";
  voegChatBericht("user", tekst);
  voegChatBericht("assistant", "â³ Even geduld...");

  const nu = new Date(), morgen = new Date();
  morgen.setDate(nu.getDate()+1);
  const fmt = d => d.toISOString().split("T")[0];

  const sys = `Je bent een slimme Nederlandse persoonlijke assistent voor een directeur.

Huidige taken:
${taken.map(t=>`- [${t.id}] [${t.categorie}] ${t.titel}${t.vervaldatum?" (voor "+t.vervaldatum+")":""}${t.voltooid?" âœ“":""}`).join("\n")||"Geen taken"}

Aankomende afspraken:
${[...afspraken,...afsprakenIcs].filter(a=>a.datum>=fmt(nu)).slice(0,8).map(a=>`- ${a.datum} ${a.startTijd}: ${a.titel}`).join("\n")||"Geen afspraken"}

Vandaag: ${fmt(nu)} | Morgen: ${fmt(morgen)}
CategorieÃ«n: Werk, Persoonlijk, Gezondheid, Yenz

Antwoord ALLEEN in JSON zonder markdown:
{"antwoord":"...","acties":[]}

Acties:
{"type":"voeg_taak_toe","titel":"...","omschrijving":"...","categorie":"Werk","vervaldatum":"YYYY-MM-DD"}
{"type":"verwijder_taak","naam":"..."}
{"type":"maak_afspraak","titel":"...","datum":"YYYY-MM-DD","startTijd":"HH:MM","eindTijd":"HH:MM","locatie":""}
{"type":"verwijder_afspraak","id":"..."}`;

  try {
    const res = await fetch(SCRIPT_URL, {
      method:"POST",
      body: JSON.stringify({
        actie:"chat",
        system: sys,
        messages: chatHistory.filter(m=>m.content!=="â³ Even geduld...").slice(-8),
        geheugenBericht: { role:"user", content:tekst }
      })
    });
    const wrapper = await res.json();
    if (!wrapper.succes) throw new Error(wrapper.fout);
    const data = wrapper.data;
    if (data.error) { chatHistory.pop(); voegChatBericht("assistant","âŒ API fout: "+data.error.message); return; }

    const raw = data.content?.map(b=>b.text||"").join("").trim();
    let parsed;
    try { parsed = JSON.parse(raw.replace(/```json|```/g,"").trim()); }
    catch { parsed = { antwoord:raw, acties:[] }; }

    const resultaten = [];
    for (const actie of (parsed.acties||[])) {
      if (actie.type==="voeg_taak_toe") {
        const r = await voegTaakToe({ titel:actie.titel, omschrijving:actie.omschrijving||"", categorie:actie.categorie||"Werk", vervaldatum:actie.vervaldatum||"" });
        if (r) resultaten.push(`âœ… Taak toegevoegd: "${r.titel}"`);
      } else if (actie.type==="verwijder_taak") {
        const t = taken.find(x=>x.titel.toLowerCase().includes(actie.naam.toLowerCase()));
        if (t) { await verwijderTaak(t.id); resultaten.push(`ğŸ—‘ï¸ Taak verwijderd: "${t.titel}"`); }
        else resultaten.push(`âš ï¸ Taak niet gevonden: "${actie.naam}"`);
      } else if (actie.type==="maak_afspraak") {
        const r = await maakAfspraak({ titel:actie.titel, datum:actie.datum, startTijd:actie.startTijd, eindTijd:actie.eindTijd||actie.startTijd, locatie:actie.locatie||"", deelnemers:"" });
        if (r) resultaten.push(`ğŸ“… Afspraak aangemaakt: "${actie.titel}" op ${actie.datum} om ${actie.startTijd}`);
      } else if (actie.type==="verwijder_afspraak") {
        await verwijderAfspraak(actie.id);
        resultaten.push(`ğŸ—‘ï¸ Afspraak verwijderd`);
      }
    }

    chatHistory.pop();
    voegChatBericht("assistant", [parsed.antwoord,...resultaten].filter(Boolean).join("\n\n"));
    spreekUit(parsed.antwoord);

  } catch(e) {
    chatHistory.pop();
    voegChatBericht("assistant","Mijn excuses, er ging iets mis: "+e.message);
  }
}
</script>
</body>
</html>
